<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>给MogileFS添加多网段支持并分别设置拷贝数 | iT2afL0rd Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">iT2afL0rd Blog</a><span class="subtitle">Energy and Persistence conquers</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>给MogileFS添加多网段支持并分别设置拷贝数</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2014-12-01</div><div class="post-categories"><a class="post-category-link" href="/categories/MogileFS/">MogileFS</a></div></div></div><article><div class="container post"><p>MogilefS是支持多个数据中心的，简单说就是支持多个网段。比如：</p>
<ul>
<li>给定两台存储节点，IP地址分别为：10.5.0.1和10.6.0.1</li>
<li>你也许会把10.5/16和10.6/16配置在两个不同的网络“区域”</li>
<li>也许意味着他们在不同的数据中心或者不同的机柜</li>
<li>如果配置没有问题，你可以指定一个文件在不同的区域中的拷贝数</li>
</ul>
<p>MogileFS目前还没有能力在多个区域里运行数据库或者Tracker。Tracker可以在任何一个区域（网段）内运行，在<code>ZoneLocal</code>这个插件的帮助下，Tracker会用本地的文件响应客户端的请求，并用来复制到远端。然而，所有的Tracker必须要连接到同一个数据库获取数据。这个很好理解。</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>在Tracker服务器上，用<code>cpan</code>安装”MogileFS::Network”。它为Tracker提供了ZoneLocal插件，同时也提供了MultipleNetworks和HostsPerNetwork这两个复制策略。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="选择复制策略"><a href="#选择复制策略" class="headerlink" title="选择复制策略"></a>选择复制策略</h3><h4 id="MultipleNetworks"><a href="#MultipleNetworks" class="headerlink" title="MultipleNetworks"></a>MultipleNetworks</h4><p>这个复制策略不需要额外的配置，定义好网络区域之后，只要把class的复制策略设置成<code>MultipleNetworks()</code>就可以了。复制程序会把文件的拷贝放到尽可能多的网络中去。理想状态下，会同时把<code>mindevcount</code>设为3或者更大。</p>
<h4 id="HostsPerNetwork"><a href="#HostsPerNetwork" class="headerlink" title="HostsPerNetwork"></a>HostsPerNetwork</h4><p>这个是比MultipleNetworks更强大的一个版本。可以让你指定每个网络区域中的拷贝数目。例如，你有<code>near</code>和<code>far</code>两个区域，你想要near里面有两份拷贝，far里面有一个拷贝，就可以这样配置<code>HostsPerNetwork(near=2,far=1)</code>。</p>
<h3 id="配置Zone"><a href="#配置Zone" class="headerlink" title="配置Zone"></a>配置Zone</h3><p>可以这样配置网络区域：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mogadm settings set network_zones near,far</span><br><span class="line">$ mogadm settings set zone_near 10.5.0.0/16</span><br><span class="line">$ mogadm settings set zone_far 10.6.0.0/16</span><br></pre></td></tr></table></figure></p>
<h3 id="设置ZoneLocal插件"><a href="#设置ZoneLocal插件" class="headerlink" title="设置ZoneLocal插件"></a>设置ZoneLocal插件</h3><p>当zone配置好了，Tracker服务器的<code>MogileFS::Network</code>也安装了之后，就可以在Tracker上打开ZoneLocal插件了。它能让Tracker知道自己在那个Zone里面，也能让Tracker知道远程客户端在那个Zone里面。当需要返回文件路径和复制文件的新拷贝时，Tracker会优先使用自己所在Zone中的文件。要打开ZoneLocal插件，需要在mogilefsd.conf文件中加入两行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local_network = 10.5.0.0/16</span><br><span class="line">plugins = ZoneLocal</span><br></pre></td></tr></table></figure></p>
<p>local_network就是Trakcer所属区域的网段。如果Tracker服务器的IP是10.5.0.50，那么local_network就应该是10.5.0.0/16。第一次增加这些配置的时候，最好在前端启动Tracker或者用telnet的!watch命令监控一下Tracker是否正常。</p>
<h3 id="设置class复制策略"><a href="#设置class复制策略" class="headerlink" title="设置class复制策略"></a>设置class复制策略</h3><p>最后剩下的就是配置class的策略了，MogileFS可以通过class来控制每个文件在不同的区域中的复制策略。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mogadm class list</span><br><span class="line">domain class mindevcount replpolicy</span><br><span class="line">-------------------- -------------------- ------------- ------------</span><br><span class="line">toast byhost 2 MultipleHosts()</span><br><span class="line">toast default 2 MultipleHosts()</span><br><span class="line">toast four 4 MultipleHosts()</span><br><span class="line">toast fourbynamenet 1 HostsPerNetwork(near=2,far=1)</span><br><span class="line">mogadm class add toast twoontwonets --replpolicy “HostsPerNetwork(near=2,far=2)”</span><br><span class="line">mogadm class modify toast twoontwonets --replpolicy “HostsPerNetwork(near=3,far=3)”</span><br></pre></td></tr></table></figure></p>
<h2 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h2><p>完成了这些配置并修改了class的复制策略之后，请记住MogileFS不会自动开始复制文件。如果你修改的class中已经存放了文件，就需要启动FSCK来重新使新的配置生效。</p>
</div><!-- comment system--><div class="container"><hr><div data-thread-key="2014/12/01/mogilefs/multiple-network-in-mogilefs/" data-title="给MogileFS添加多网段支持并分别设置拷贝数" data-url="http://lsq.me/2014/12/01/mogilefs/multiple-network-in-mogilefs/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'lamberts'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:qsunme@vangoals.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/iT2afL0rd" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">iT2afL0rd Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>