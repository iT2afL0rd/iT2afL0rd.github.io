<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CentOS 7上Kubernetes集群的安装与配置 | iT2afL0rd's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">iT2afL0rd's Blog</a><span class="subtitle">Energy and Persistence conquers</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>CentOS 7上Kubernetes集群的安装与配置</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-01-14</div><div class="post-categories"><a class="post-category-link" href="/categories/Kubernetes/">Kubernetes</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/Docker/">Docker</a>/<a class="post-tag-link" href="/tags/Etcd/">Etcd</a></div></div></div><article><div class="container post"><p>Kubernetes是一个Master/Slave(Minion)架构的容器管理平台。</p>
<h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><ul>
<li>IP: 10.64.203.234</li>
<li>OS: CentOS 7</li>
<li>etcd: 2.1.1</li>
</ul>
<h3 id="Minion-1"><a href="#Minion-1" class="headerlink" title="Minion #1"></a>Minion #1</h3><ul>
<li>IP: 10.64.203.235</li>
<li>OS: CentOS 7</li>
</ul>
<h3 id="Minion-2"><a href="#Minion-2" class="headerlink" title="Minion #2"></a>Minion #2</h3><ul>
<li>IP: 10.64.203.236</li>
<li>OS: CentOS 7</li>
<li>Kubernetes: Release 1.0.3</li>
<li>Docker: 1.8.2</li>
<li>Flanneld: 0.2.0</li>
</ul>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><p>为了避免和Docker的iptables产生冲突，我们需要关闭Minion上的防火墙：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop firewalld</span><br><span class="line">$ systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h4 id="安装NTP"><a href="#安装NTP" class="headerlink" title="安装NTP"></a>安装NTP</h4><p>为了让各个服务器的时间保持一致，还需要为所有的服务器安装NTP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install ntp</span><br><span class="line">$ systemctl start ntpd</span><br><span class="line">$ systemctl enable ntpd</span><br></pre></td></tr></table></figure>
<h2 id="部署Master"><a href="#部署Master" class="headerlink" title="部署Master"></a>部署Master</h2><h3 id="安装etcd和kubernetes"><a href="#安装etcd和kubernetes" class="headerlink" title="安装etcd和kubernetes"></a>安装etcd和kubernetes</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install etcd kubernetes</span><br></pre></td></tr></table></figure>
<h3 id="配置etcd"><a href="#配置etcd" class="headerlink" title="配置etcd"></a>配置etcd</h3><p>修改etcd的配置文件<code>/etc/etcd/etcd.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ETCD_NAME=default</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;http://0.0.0.0:2379&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置etcd中的网络"><a href="#配置etcd中的网络" class="headerlink" title="配置etcd中的网络"></a>配置etcd中的网络</h3><p>定义etcd中的网络配置，minions中的flannel service会拉取此配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl mk /coreos.com/network/config &apos;&#123;&quot;Network&quot;:&quot;172.17.0.0/16&quot;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<h3 id="配置Kubernetes-API-server"><a href="#配置Kubernetes-API-server" class="headerlink" title="配置Kubernetes API server"></a>配置Kubernetes API server</h3><p>修改配置文件<code>/etc/kubernetes/apiserver</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">API_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line">KUBE_API_PORT=&quot;--port=8080&quot;</span><br><span class="line">KUBELET_PORT=&quot;--kubelet_port=10250&quot;</span><br><span class="line">KUBE_ETCD_SERVERS=&quot;--etcd_servers=http://10.64.203.234:2379&quot;</span><br><span class="line">KUBE_SERVICE_ADDRESSES=&quot;--portal_net=10.254.0.0/16&quot;</span><br><span class="line">KUBE_ADMISSION_CONTROL=&quot;--admission_control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&quot;</span><br><span class="line">KUBE_API_ARGS=&quot;&quot;</span><br></pre></td></tr></table></figure>
<p>这里需要注意原来<code>KUBE_ADMISSION_CONTROL</code>默认包含的<code>ServiceAccount</code>要删掉，不然启动API server的时候会报错。</p>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p>接下来，在Master上启动下面的服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$for SERVICES in etcd kube-apiserver kube-controller-manager kube-scheduler; do </span><br><span class="line">systemctl restart $SERVICES</span><br><span class="line">systemctl enable $SERVICES</span><br><span class="line">systemctl status $SERVICES </span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="部署Minion"><a href="#部署Minion" class="headerlink" title="部署Minion"></a>部署Minion</h2><h3 id="安装Kubernetes和Flannel"><a href="#安装Kubernetes和Flannel" class="headerlink" title="安装Kubernetes和Flannel"></a>安装Kubernetes和Flannel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install flannel kubernetes</span><br></pre></td></tr></table></figure>
<h3 id="配置Flannel"><a href="#配置Flannel" class="headerlink" title="配置Flannel"></a>配置Flannel</h3><p>修改Flannel的配置文件<code>/etc/sysconfig/flanneld</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FLANNEL_ETCD=&quot;http://10.64.203.234:2379&quot;</span><br><span class="line">FLANNEL_ETCD_KEY=&quot;/coreos.com/network&quot;</span><br><span class="line">FLANNEL_OPTIONS=&quot;--iface=bond0&quot;</span><br></pre></td></tr></table></figure>
<p>这里需要注意<code>FLANNEL_OPTIONS</code>中的iface的值是你自己服务器的网卡，不同的服务器以及配置下和我的是不一样的。</p>
<h3 id="启动Flannel"><a href="#启动Flannel" class="headerlink" title="启动Flannel"></a>启动Flannel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$systemctl restart flanneld</span><br><span class="line">$systemctl enable flanneld</span><br><span class="line">$systemctl status flanneld</span><br></pre></td></tr></table></figure>
<h3 id="上传网络配置"><a href="#上传网络配置" class="headerlink" title="上传网络配置"></a>上传网络配置</h3><p>在当前目录下创建一个<code>config.json</code>，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;Network&quot;: &quot;172.17.0.0/16&quot;,</span><br><span class="line">&quot;SubnetLen&quot;: 24,</span><br><span class="line">&quot;Backend&quot;: &#123;</span><br><span class="line">     &quot;Type&quot;: &quot;vxlan&quot;,</span><br><span class="line">     &quot;VNI&quot;: 7890</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>然后将配置上传到etcd服务器上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L http://10.64.203.234:2379/v2/keys/coreos.com/network/config -XPUT --data-urlencode value@config.json</span><br></pre></td></tr></table></figure>
<h3 id="修改Kubernetes配置"><a href="#修改Kubernetes配置" class="headerlink" title="修改Kubernetes配置"></a>修改Kubernetes配置</h3><p>修改kubernetes默认的配置文件<code>/etc/kubernetes/config</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBE_MASTER=&quot;--master=http://10.64.203.234:8080&quot;</span><br></pre></td></tr></table></figure>
<h3 id="修改kubelet配置"><a href="#修改kubelet配置" class="headerlink" title="修改kubelet配置"></a>修改kubelet配置</h3><p>修改kubelet服务的配置文件<code>/etc/kubernetes/kubelet</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line">KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line"># change the hostname to minion IP address</span><br><span class="line">KUBELET_HOSTNAME=&quot;--hostname_override=10.64.203.235&quot;</span><br><span class="line">KUBELET_API_SERVER=&quot;--api_servers=http://10.64.203.234:8080&quot;</span><br><span class="line">KUBELET_ARGS=&quot;&quot;</span><br></pre></td></tr></table></figure>
<p>不同minion节点只需要更改KUBELET_HOSTNAME 为minion实际的ip地址即可。</p>
<h3 id="启动Minion服务"><a href="#启动Minion服务" class="headerlink" title="启动Minion服务"></a>启动Minion服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ for SERVICES in kube-proxy kubelet docker; do </span><br><span class="line">systemctl restart $SERVICES</span><br><span class="line">systemctl enable $SERVICES</span><br><span class="line">systemctl status $SERVICES </span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><p>部署完成之后，可以kubectl命令来查看整个集群的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$kubectl -s &quot;http://10.64.203.234:8080&quot; get nodes</span><br><span class="line">NAME           LABELS                                STATUS</span><br><span class="line">10.64.203.235   kubernetes.io/hostname=10.64.203.235   Ready</span><br><span class="line">10.64.203.236   kubernetes.io/hostname=10.64.203.236   Ready</span><br></pre></td></tr></table></figure>
<p>得到这样的输出，那么Kubernetes集群就搭建好了。</p>
</div><!-- comment system--><div data-thread-key="2016/01/14/containers/k8s-cluster-setup-in-centos-7/" data-title="CentOS 7上Kubernetes集群的安装与配置" data-url="http://lsq.me/2016/01/14/containers/k8s-cluster-setup-in-centos-7/" class="container ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div class="container"><hr><div data-thread-key="2016/01/14/containers/k8s-cluster-setup-in-centos-7/" data-title="CentOS 7上Kubernetes集群的安装与配置" data-url="http://lsq.me/2016/01/14/containers/k8s-cluster-setup-in-centos-7/" data-author-key="1" class="ds-thread"></div></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:qsunme@126.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/iT2afL0rd" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">iT2afL0rd's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>